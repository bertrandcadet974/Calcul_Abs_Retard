<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des élèves avec périodes excusées</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f5f5f5; }
    .bar-container {
      width: 100px;
      background: #eee;
      border-radius: 4px;
      position: relative;
      height: 14px;
      overflow: hidden;
    }
    .bar-fill {
      height: 100%;
      border-radius: 4px;
      color: #000;
      font-size: 10px;
      font-weight: bold;
      line-height: 14px;
      text-align: center;
      white-space: nowrap;
    }
    img.guide {
      width: 50%;
      height: auto;
      margin-bottom: 20px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .file-upload-section {
      margin-bottom: 2rem;
    }
  </style>
</head>
<body>

  <h2>Calcul des absences excusées et non excusées en incluant les retards</h2>
  <p><strong>Étape 1 :</strong> Exporter le fichier depuis Webuntis en format Excel (.xlsx)</p>
  <img src="webuntis_export.png" alt="Explication export Webuntis" class="guide">

  <div class="file-upload-section">
    <p><strong>Étape 2 :</strong> Importer le fichier Excel</p>
    <input type="file" id="upload" accept=".xlsx, .xls" />
  </div>

  <div id="output"></div>

  <script>
    function excelDateToJSDate(excelDate) {
      return new Date(Math.round((excelDate - 25569) * 86400 * 1000));
    }

    document.getElementById('upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (json.length < 2) {
            document.getElementById('output').innerText = "Aucune donnée trouvée.";
            return;
          }

          const rows = json.slice(1);
          const names = rows.map(row => row[0]).filter(name => !!name);
          const uniqueNames = [...new Set(names)];

          const dateList = rows.map(row => {
            const raw = row[4];
            if (typeof raw === "number") return excelDateToJSDate(raw);
            if (typeof raw === "string") {
              const parsed = new Date(raw);
              return !isNaN(parsed) ? parsed : null;
            }
            return null;
          }).filter(date => date instanceof Date && !isNaN(date));

          const globalStart = dateList.length > 0
            ? new Date(Math.min(...dateList)).toLocaleDateString('fr-FR') : "—";

          const globalEnd = dateList.length > 0
            ? new Date(Math.max(...dateList)).toLocaleDateString('fr-FR') : "—";

          const stats = uniqueNames.map(name => {
            const studentRows = rows.filter(row => row[0] === name);

            const sumExcuse = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const value = parseFloat(row[7]);
              return motif === "excusé" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sumOuvertNonVide = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const start = row[10]?.toString().trim();
              const value = parseFloat(row[7]);
              return motif === "ouvert" && start !== "" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sommeFinaleExcuse = sumExcuse + sumOuvertNonVide;
            const periodeexcusee = Math.round(sommeFinaleExcuse / 45);

            const sumNONExcuse = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const value = parseFloat(row[7]);
              return motif === "non excusé" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sumOuvertVide = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const start = row[10]?.toString().trim();
              const value = parseFloat(row[7]);
              return motif === "ouvert" && start === "" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sommeNONFinale = sumNONExcuse + sumOuvertVide;
            const periodeNONexcusee = Math.round(sommeNONFinale / 45);

            return {
              name,
              periodeexcusee,
              periodeNONexcusee
            };
          });

          let html = `
            <p>
              <strong>Date de début :</strong> ${globalStart} |
              <strong>Date de fin :</strong> ${globalEnd}
            </p>
            <table>
              <thead>
                <tr>
                  <th>Nom de l'élève</th>
                  <th>Absences excusées</th>
                  <th>Absences NON excusées</th>
                  <th>Absences NON excusées (sur 48)</th>
                </tr>
              </thead>
              <tbody>
          `;

          stats.forEach(entry => {
            const percent = Math.min(entry.periodeNONexcusee / 48, 1);
            const percentText = Math.round(percent * 100) + "%";

            // Dégradé vert -> orange -> rouge
            let color;
            if (percent <= 0.5) {
              const r = Math.round(0 + (255 - 0) * (percent / 0.5));
              const g = Math.round(204 + (204 - 204) * (percent / 0.5));
              color = `rgb(${r}, ${g}, 0)`;
            } else {
              const r = 255;
              const g = Math.round(204 - 204 * ((percent - 0.5) / 0.5));
              color = `rgb(${r}, ${g}, 0)`;
            }

            const bar = `
              <div class="bar-container">
                <div class="bar-fill" style="width: ${percent * 100}%; background: ${color};">
                  ${percentText}
                </div>
              </div>
            `;

            html += `<tr>
              <td>${entry.name}</td>
              <td>${entry.periodeexcusee}</td>
              <td>${entry.periodeNONexcusee}</td>
              <td>${bar}</td>
            </tr>`;
          });

          html += "</tbody></table>";
          document.getElementById('output').innerHTML = html;

        } catch (err) {
          document.getElementById('output').innerText = "Erreur : " + err.message;
        }
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
