<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Liste des élèves avec périodes excusées</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f5f5f5; }
  </style>
</head>
<body>

  <h2>Uploader un fichier Excel</h2>
  <input type="file" id="upload" accept=".xlsx, .xls" />
  <div id="output"></div>

  <script>
    document.getElementById('upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (json.length < 2) {
            document.getElementById('output').innerText = "Aucune donnée trouvée.";
            return;
          }

          const rows = json.slice(1);
          const names = rows.map(row => row[0]).filter(name => !!name);
          const uniqueNames = [...new Set(names)];

          const stats = uniqueNames.map(name => {
            const studentRows = rows.filter(row => row[0] === name);

            // Comptage Excusé
            //const countExcuse = studentRows.filter(row =>
            //  row[17]?.toString().trim().toLowerCase() === "excusé"
            //).length;

            //const countOuvertNonVide = studentRows.filter(row =>
            //  row[17]?.toString().trim().toLowerCase() === "ouvert" &&
            //  row[10]?.toString().trim() !== ""
            //).length;

            //const totalExcuse = countExcuse + countOuvertNonVide;

            // Nombre de minutes excusées
            const sumExcuse = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const value = parseFloat(row[7]);
              return motif === "excusé" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sumOuvertNonVide = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const start = row[10]?.toString().trim();
              const value = parseFloat(row[7]);
              return motif === "ouvert" && start !== "" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sommeFinaleExcuse = sumExcuse + sumOuvertNonVide;

            // Nombre de périodes excusées (arrondi à l'unité)
            const periodeexcusee = Math.round(sommeFinaleExcuse / 45);

            // Comptage NON Excusé
            //const countNONExcuse = studentRows.filter(row =>
            //  row[17]?.toString().trim().toLowerCase() === "non excusé"
            //).length;

            //const countOuvertNonVide = studentRows.filter(row =>
            //  row[17]?.toString().trim().toLowerCase() === "ouvert" &&
            //  row[10]?.toString().trim() !== ""
            //).length;

            //const total = countExcuse + countOuvertNonVide;

            // Nombre de minutes NON excusées
            const sumNONExcuse = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const value = parseFloat(row[7]);
              return motif === "non excusé" && !isNaN(value) ? acc + value : acc;
            }, 0);

            const sumOuvertVide = studentRows.reduce((acc, row) => {
              const motif = row[17]?.toString().trim().toLowerCase();
              const start = row[10]?.toString().trim();
              const value = parseFloat(row[7]);
              return motif === "ouvert" && start === "" ? acc + value : acc;
            }, 0);

            const sommeNONFinale = sumNONExcuse + sumOuvertVide;

            // Nombre de périodes NON excusées (arrondi à l'unité)
            const periodeNONexcusee = Math.round(sommeNONFinale / 45);

            return {
              name,
              periodeexcusee,
              periodeNONexcusee
            };
          });

          // Générer le tableau HTML (nom + périodes excusées uniquement)
          let html = `
            <table>
              <thead>
                <tr>
                  <th>Nom de l'élève</th>
                  <th>Nombre de périodes excusées</th>
                  <th>Nombre de périodes NON excusées</th>
                </tr>
              </thead>
              <tbody>
          `;

          stats.forEach(entry => {
            html += `<tr>
              <td>${entry.name}</td>
              <td>${entry.periodeexcusee}</td>
              <td>${entry.periodeNONexcusee}</td>
            </tr>`;
          });

          html += "</tbody></table>";
          document.getElementById('output').innerHTML = html;

        } catch (err) {
          document.getElementById('output').innerText = "Erreur : " + err.message;
        }
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
