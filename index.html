<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Suivi des élèves</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #f5f5f5; }
  </style>
</head>
<body>

  <h2>Uploader un fichier Excel</h2>
  <input type="file" id="upload" accept=".xlsx, .xls" />
  <div id="output"></div>

  <script>
    document.getElementById('upload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (json.length < 2) {
            document.getElementById('output').innerText = "Aucune donnée trouvée.";
            return;
          }

          const rows = json.slice(1); // Ignorer l'en-tête
          const names = rows.map(row => row[0]).filter(name => !!name);
          const uniqueNames = [...new Set(names)];

          const stats = uniqueNames.map(name => {
            // Retards
            const retards = rows.filter(row =>
              row[0] === name && row[10]?.toString().toLowerCase() === "retard"
            );
            const retardCount = retards.length;
            const totalMinutes = retards.reduce((sum, row) => {
              const minutes = parseFloat(row[7]);
              return sum + (isNaN(minutes) ? 0 : minutes);
            }, 0);
            const totalHours = Math.round(totalMinutes / 60);

            // Absences excusées
            const absExcusees = rows.filter(row =>
              row[0] === name &&
              row[17]?.toString().toLowerCase() === "excusé" &&
              row[10]?.toString().toLowerCase() !== "retard"
            );
            const nbAbsExcusees = absExcusees.length;
            const minutesAbsExcusees = absExcusees.reduce((sum, row) => {
              const minutes = parseFloat(row[7]);
              return sum + (isNaN(minutes) ? 0 : minutes);
            }, 0);
            const heuresAbsExcusees = Math.round(minutesAbsExcusees / 60);

            // Absences non excusées
            const absNonExcusees = rows.filter(row =>
              row[0] === name &&
              row[17]?.toString().toLowerCase() !== "excusé" &&
              row[10]?.toString().toLowerCase() !== "retard"
            );
            const nbAbsNonExcusees = absNonExcusees.length;
            const minutesAbsNonExcusees = absNonExcusees.reduce((sum, row) => {
              const minutes = parseFloat(row[7]);
              return sum + (isNaN(minutes) ? 0 : minutes);
            }, 0);
            const heuresAbsNonExcusees = Math.round(minutesAbsNonExcusees / 60);

            return {
              name,
              retardCount,
              totalMinutes,
              totalHours,
              nbAbsExcusees,
              minutesAbsExcusees,
              heuresAbsExcusees,
              nbAbsNonExcusees,
              minutesAbsNonExcusees,
              heuresAbsNonExcusees
            };
          });

          // Générer le tableau HTML
          let html = `
            <table>
              <thead>
                <tr>
                  <th>Nom de l'élève</th>
                  <th>Nombre de retards</th>
                  <th>Minutes de retard</th>
                  <th>Heure(s) de retard</th>
                  <th>Absences excusées</th>
                  <th>Minute(s) absence excusée</th>
                  <th>Heure(s) absence excusée</th>
                  <th>Absences non excusées</th>
                  <th>Minute(s) absence non excusée</th>
                  <th>Heure(s) absence non excusée</th>
                </tr>
              </thead>
              <tbody>
          `;
          stats.forEach(entry => {
            html += `<tr>
              <td>${entry.name}</td>
              <td>${entry.retardCount}</td>
              <td>${entry.totalMinutes}</td>
              <td>${entry.totalHours}</td>
              <td>${entry.nbAbsExcusees}</td>
              <td>${entry.minutesAbsExcusees}</td>
              <td>${entry.heuresAbsExcusees}</td>
              <td>${entry.nbAbsNonExcusees}</td>
              <td>${entry.minutesAbsNonExcusees}</td>
              <td>${entry.heuresAbsNonExcusees}</td>
            </tr>`;
          });
          html += "</tbody></table>";

          document.getElementById('output').innerHTML = html;
        } catch (err) {
          document.getElementById('output').innerText = "Erreur : " + err.message;
        }
      };

      reader.readAsArrayBuffer(file);
    });
  </script>
</body>
</html>
